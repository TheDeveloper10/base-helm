name: Publish Helm charts (OCI)

on:
  push:
    branches: [ main, feat/cicd ]
    paths:
      - 'base-app/**'
      - 'base-np-security/**'
  workflow_dispatch: {}

jobs:
  publish:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    strategy:
      matrix:
        chart_name: [base-app, base-np-security]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.16.0

      - name: Login to Helm Registry
        run: |
          echo "${{ secrets.REGISTRY_TOKEN }}" | helm registry login ${{ secrets.REGISTRY_URL }} \
            -u "${{ secrets.REGISTRY_USERNAME }}" --password-stdin

      - name: Package chart
        id: package
        env:
          CHART_NAME: ${{ matrix.chart_name }}
        run: |
          CHART_DIR="./${CHART_NAME}"

          VERSION=$(helm show chart "$CHART_DIR" | awk '/^version:/ {print $2}')
          echo "Detected version: $VERSION for $CHART_NAME"

          echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"

          mkdir -p packaged
          helm package "$CHART_DIR" --destination packaged

      - name: Push chart
        env:
          CHART_NAME: ${{ matrix.chart_name }}
          VERSION: ${{ steps.package.outputs.VERSION }}
        run: |
          OCI_NAMESPACE="${{ secrets.REGISTRY_URL }}/${{ secrets.REGISTRY_USERNAME }}"

          helm push "packaged/${CHART_NAME}-${VERSION}.tgz" "oci://${OCI_NAMESPACE}"
